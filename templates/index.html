  <!DOCTYPE html>
  <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Hacker's Community</title>
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
      />
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <style>
        /* ê°¤ëŸ¬ë¦¬ ë²„íŠ¼ (ë¹„ìœ¨ ë§ì¶¤ & ê°€ë¡œ ìŠ¤í¬ë¡¤) */
        .gallery-scroll-box {
          display: flex;
          gap: 10px;
          overflow-x: auto;
          padding-bottom: 10px;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
        }
        .gallery-scroll-box::-webkit-scrollbar {
          display: none;
        }

        .gallery-btn {
          flex: 0 0 auto;
          padding: 8px 16px;
          border-radius: 20px;
          font-weight: 600;
          font-size: 0.9rem;
          border: 1px solid #dee2e6;
          background: white;
          color: #555;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .gallery-btn.active {
          background: #343a40;
          color: white;
          border-color: #343a40;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        /* ğŸ”¥ ì„¸ë ¨ëœ ê²€ìƒ‰ë°” ìŠ¤íƒ€ì¼ */
        .custom-search-bar {
          background: white;
          border-radius: 50px;
          padding: 5px 5px 5px 20px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          display: flex;
          align-items: center;
          width: 100%;
          max-width: 500px;
          margin: 0 auto;
          transition: all 0.3s ease;
          border: 1px solid transparent;
        }

        .custom-search-bar:focus-within {
          border-color: #0d6efd;
          box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
        }

        .search-input {
          border: none;
          outline: none;
          flex-grow: 1;
          padding: 0 15px;
          font-size: 0.95rem;
        }

        .search-btn {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: none;
          background: #0d6efd;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: 0.2s;
        }
        .search-btn:hover {
          background: #0b5ed7;
          transform: scale(1.05);
        }

        /* ëª¨ë°”ì¼ì—ì„œëŠ” ê²€ìƒ‰ë°”ê°€ ê½‰ ì°¨ë„ë¡ */
        @media (max-width: 768px) {
          .custom-search-bar {
            margin-top: 10px;
            max-width: 100%;
          }
          .navbar-nav {
            margin-top: 15px;
          }
        }

        .post-title-truncate {
          display: block;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 100%;
        }

        .guide-text {
          font-size: 0.5rem;
          background: rgba(255, 255, 255, 0.2);
          padding: 4px 10px;
          border-radius: 20px;
          border: 1px dashed rgba(255, 255, 255, 0.5);
          font-weight: bold;
          color: #fffae3 !important;
          transition: all 0.4s ease;
          opacity: 1;
          transform: translateX(0);
        }
        .guide-hidden {
          opacity: 0 !important;
          transform: translateX(20px) scale(0.8);
          pointer-events: none;
        }

        @keyframes bounce-x {
          0%, 100% { transform: translateX(0); }
          50% { transform: translateX(7px); }
        }
        .animate-bounce {
          animation: bounce-x 0.8s infinite;
        }

        body { background-color: #f8f9fa; }
        .navbar { background: #343a40; }
        .navbar-brand { font-size: 1.2rem; }

        .list-group-item {
          transition: 0.2s;
          border-left: 5px solid transparent;
          position: relative;
        }
        .list-group-item:hover {
          background-color: #f1f3f5;
          border-left: 5px solid #0d6efd;
          transform: translateX(5px);
        }

        .write-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          font-size: 24px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
          z-index: 1000;
        }

        .post-img-preview {
          width: 100%;
          height: 250px;
          object-fit: cover;
          border-radius: 8px;
          margin-bottom: 15px;
          border: 1px solid #eee;
        }

        .account-box {
          background: #f1f3f5;
          padding: 15px;
          border-radius: 10px;
          font-family: monospace;
          font-size: 1.1rem;
        }

        .grade-badge {
          font-size: 0.75rem;
          padding: 2px 6px;
          border-radius: 4px;
          margin-left: 3px;
          vertical-align: middle;
          color: white;
          font-weight: bold;
          background-color: #0d6efd;
        }
        .grade-badge[data-grade="ê³¨ë“œ"] {
          background-color: #ffd700;
          color: #000;
          border: 1px solid #e0c200;
          box-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        .grade-badge[data-grade="ë‹¤ì´ì•„ëª¬ë“œ"] {
          background-color: #00e1ff;
          color: #fff;
          box-shadow: 0 0 5px #00e1ff;
        }
        .grade-badge[data-grade="ë„ˆ ì§± ìµœê³ "] {
          background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
          background-size: 400%;
          animation: rainbow 3s linear infinite;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .grade-badge[data-grade="ê´€ë¦¬ì"] {
          background-color: #dc3545;
          box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
          border: 1px solid #a71d2a;
          padding-left: 8px;
          padding-right: 8px;
        }
        .grade-badge[data-grade="ê´€ë¦¬ì"]::before { content: "ğŸ‘‘ "; }
        @keyframes rainbow {
          0% { background-position: 0% 50%; }
          100% { background-position: 100% 50%; }
        }

        .donation-icon {
          font-size: 4rem;
          color: #ff6b6b;
          animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
          0% { transform: translateY(0px); }
          50% { transform: translateY(-10px); }
          100% { transform: translateY(0px); }
        }
        .account-card {
          background-color: #f1f3f5;
          border-radius: 15px;
          padding: 15px;
          position: relative;
          border: 1px solid #dee2e6;
        }
        .bank-logo {
          width: 40px;
          height: 40px;
          background: #fff;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: #0064ff;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
      </style>
    </head>

    <body>
      <nav class="navbar navbar-expand-lg navbar-dark mb-4 px-3">
        <div class="container flex-wrap flex-lg-nowrap">
          <a class="navbar-brand fw-bold order-1" href="/">
            <i class="fas fa-shield-alt"></i> Secure Community
          </a>

          <button
            class="navbar-toggler order-2"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          {% if not session.get('username') %}
          <div
            id="join-guide"
            class="d-lg-none text-white guide-text animate-bounce order-2"
            style="position: absolute; right: 70px; top: 18px; z-index: 10"
          >
            ê°€ì… í•´ì£¼ì„¸ìš”! <i class="fas fa-arrow-right"></i>
          </div>
          {% endif %}

          <form
            action="{{ url_for('main.index') }}"
            method="GET"
            class="d-flex ms-lg-4 me-auto my-2 my-lg-0 order-3 order-lg-2"
            style="max-width: 400px; width: 100%"
          >
            <div class="custom-search-bar">
              <input
                type="hidden"
                name="g_id"
                value="{{ request.args.get('g_id', '0') }}"
              />
              <i class="fas fa-search text-muted ms-3"></i>
              <input
                name="q"
                class="search-input"
                type="search"
                placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..."
                value="{{ request.args.get('q', '') }}"
              />
              <button class="search-btn" type="submit">Go</button>
            </div>
          </form>

          <div
            class="collapse navbar-collapse justify-content-end order-4"
            id="navbarNav"
          >
            <div class="navbar-nav align-items-center mt-3 mt-lg-0 gap-2">
              {% if session.get('is_admin') %}
              <a
                href="/admin"
                class="btn btn-warning btn-sm fw-bold w-100 w-lg-auto text-nowrap"
                ><i class="fas fa-cogs"></i> ê´€ë¦¬ì í˜ì´ì§€</a
              >
              {% endif %}{% if session.get('username') %}
              <span class="text-white fw-bold me-2 mb-2 mb-lg-0 text-nowrap">
                <div class="dropdown d-inline-block me-2">
                  <button
                    class="btn btn-link text-white position-relative p-0"
                    type="button"
                    data-bs-toggle="dropdown"
                    onclick="markAsRead()"
                  >
                    <i class="fas fa-bell fs-5"></i>
                    <span
                      id="noti-badge"
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                      style="display: none; font-size: 0.6rem;"
                    >
                      0
                    </span>
                  </button>
                  <ul
                    class="dropdown-menu dropdown-menu-end shadow border-0"
                    id="noti-list"
                    style="width: 280px; font-size: 0.85rem; border-radius: 12px;"
                  >
                    <li class="dropdown-header fw-bold">ìƒˆë¡œìš´ ì•Œë¦¼</li>
                    <div id="noti-items">
                      <li class="text-center py-3 text-muted small">
                        ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                      </li>
                    </div>
                  </ul>
                </div>
                <i class="fas fa-user"></i>

                {{ session.get('username') }} {% if session.get('is_admin') %}
                <span class="grade-badge" data-grade="ê´€ë¦¬ì">ê´€ë¦¬ì</span>
                {% else %}
                <span
                  class="grade-badge"
                  data-grade="{{ session.get('grade') or 'ì¼ë°˜' }}"
                >
                  {{ session.get('grade') or 'ì¼ë°˜' }}
                </span>
                {% endif %}
              </span>
              <a
                href="/settings"
                class="btn btn-outline-light btn-sm w-100 w-lg-auto text-nowrap"
                ><i class="fas fa-cog"></i> ì„¤ì •</a
              >
              <button
                type="button"
                class="btn btn-outline-danger btn-sm w-100 w-lg-auto text-nowrap"
                data-bs-toggle="modal"
                data-bs-target="#logoutModal"
              >
                ë¡œê·¸ì•„ì›ƒ
              </button>
              {% else %}
              <a
                href="/login"
                class="btn btn-light btn-sm fw-bold w-100 w-lg-auto text-nowrap"
                >ë¡œê·¸ì¸</a
              >
              <a
                href="/register"
                class="btn btn-outline-light btn-sm w-100 w-lg-auto text-nowrap"
                >íšŒì›ê°€ì…</a
              >
              {% endif %}
            </div>
          </div>
        </div>
      </nav>

      <div class="container" style="min-height: 80vh">
        <div class="gallery-nav-container mb-4 mt-3">
          <div
            class="d-flex flex-nowrap gap-2 overflow-auto pb-2 justify-content-start justify-content-md-center"
            style="scrollbar-width: none; -ms-overflow-style: none;"
          >
            <a
              href="{{ url_for('main.index') }}"
              class="btn rounded-pill fw-bold px-4 text-nowrap {{ 'btn-dark' if not request.args.get('g_id') or request.args.get('g_id') == '0' else 'btn-outline-dark bg-white' }}"
              style="border: 2px solid #343a40; transition: 0.3s"
              >ğŸ“‚ ì „ì²´</a
            >
            {# ğŸ”¥ ìˆ˜ì •: í•„í„° ì—†ì´ ëª¨ë“  ê°¤ëŸ¬ë¦¬ í‘œì‹œ #} {% for g in galleries %}
            <a
              href="{{ url_for('main.index', g_id=g.id) }}"
              class="btn rounded-pill fw-bold px-3 text-nowrap {{ 'btn-primary' if request.args.get('g_id')|string == g.id|string else 'btn-outline-secondary bg-white' }}"
              style="border: 2px solid {{ '#0d6efd' if request.args.get('g_id')|string == g.id|string else '#dee2e6' }};"
              >{{ g.name }}</a
            >
            {% endfor %}

            <button
              class="btn rounded-pill fw-bold px-3 text-nowrap btn-outline-secondary bg-white"
              style="border: 2px solid #dee2e6;"
              data-bs-toggle="modal"
              data-bs-target="#userGalleryModal"
            >
              <i class="fas fa-users"></i> ì‚¬ìš©ì ê°¤ëŸ¬ë¦¬
            </button>
          </div>
        </div>
        <div class="modal fade" id="userGalleryModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div
              class="modal-content border-0 shadow-lg"
              style="border-radius: 20px;"
            >
              <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">
                  <i class="fas fa-layer-group text-primary"></i> ì‚¬ìš©ì ê°¤ëŸ¬ë¦¬
                  ëª©ë¡
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div
                class="modal-body bg-light"
                style="max-height: 60vh; overflow-y: auto;"
              >
                <div
                  class="input-group mb-3 sticky-top"
                  style="top: -16px; background: #f8f9fa; padding-top: 15px; z-index: 10;"
                >
                  <span class="input-group-text bg-white border-end-0"
                    ><i class="fas fa-search text-muted"></i
                  ></span>
                  <input
                    type="text"
                    id="modalSearchInput"
                    class="form-control border-start-0"
                    placeholder="ê°¤ëŸ¬ë¦¬ ì´ë¦„ ê²€ìƒ‰..."
                    onkeyup="if(window.event.keyCode==13){searchModalGalleries()}"
                    oninput="if(this.value.trim() === '') { searchModalGalleries(); }"
                  />
                  <button class="btn btn-dark" onclick="searchModalGalleries()">
                    ê²€ìƒ‰
                  </button>
                </div>

                <div class="row g-3" id="modal-gallery-list">
                  <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                  </div>
                </div>

                <div class="text-center mt-4">
                  <button
                    id="modalLoadMoreBtn"
                    class="btn btn-outline-dark rounded-pill px-4 btn-sm"
                    onclick="fetchUserGalleries(true)"
                  >
                    ë”ë³´ê¸° <i class="fas fa-chevron-down"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-8 mx-auto" id="main-content">
            {% if is_locked %}
            <div
              class="card shadow-lg border-0 text-center p-5 mb-5"
              style="border-radius: 20px;"
            >
              <div class="mb-3">
                <i class="fas fa-lock fa-4x text-warning"></i>
              </div>
              <h3 class="fw-bold">ë³´ì•ˆ ê°¤ëŸ¬ë¦¬ì…ë‹ˆë‹¤</h3>
              <p class="text-muted">
                ì´ ê°¤ëŸ¬ë¦¬ì— ì…ì¥í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
              </p>
              <form
                action="{{ url_for('main.index') }}"
                method="GET"
                class="d-flex justify-content-center mt-3"
              >
                <input
                  type="hidden"
                  name="g_id"
                  value="{{ request.args.get('g_id') }}"
                />
                <input
                  type="password"
                  name="pw"
                  class="form-control w-50 me-2"
                  placeholder="ë¹„ë°€ë²ˆí˜¸"
                  required
                />
                <button class="btn btn-dark">ì…ì¥</button>
              </form>
            </div>
            <style>
              #post-list, .btn-outline-dark { display: none !important; }
            </style>
            {% endif %} {% if top_posts %}
            <div class="mb-4">
              <h6 class="fw-bold mb-3 text-secondary">
                <i class="fas fa-fire text-danger"></i> ì§€ê¸ˆ ëœ¨ëŠ” ê²Œì‹œë¬¼
              </h6>
              <div class="d-flex flex-column gap-2">
                {% for top in top_posts %}
                <a
                  href="{{ url_for('main.post_detail', post_id=top.id) }}"
                  class="text-decoration-none"
                >
                  <div class="card shadow-sm border-0 bg-white hover-effect">
                    <div class="card-body p-3 d-flex align-items-center">
                      <span class="badge bg-danger me-3 rounded-pill text-nowrap"
                        >{{ loop.index }}ìœ„</span
                      >
                      <div class="flex-grow-1" style="min-width: 0">
                        <div class="d-flex align-items-center gap-2 mb-1">
                          <span
                            class="badge bg-light text-dark border text-nowrap"
                            >{{ top.galleries.name }}</span
                          >
                          <h6 class="fw-bold text-dark mb-0 text-truncate">
                            {{ top.title }}
                          </h6>
                        </div>
                      </div>
                      <div class="text-muted small text-nowrap ms-3">
                        <i class="fas fa-thumbs-up text-primary"></i> ì¶”ì²œ
                      </div>
                    </div>
                  </div>
                </a>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <div class="mb-4">
              <div
                class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2"
              >
                <h5 class="fw-bold text-danger m-0">
                  <i class="fas fa-bullhorn"></i> ê³µì§€ì‚¬í•­
                </h5>
                {% if session.get('is_admin') %}
                <button
                  class="btn btn-sm btn-outline-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#noticeModal"
                >
                  ê³µì§€ ì“°ê¸°
                </button>
                {% endif %}
              </div>
              {% for notice in notices %}
              <div
                class="alert alert-light border shadow-sm d-flex justify-content-between align-items-center py-2 px-3 mb-2"
              >
                <div class="text-truncate" style="max-width: 85%">
                  <span class="badge bg-danger me-2">NOTICE</span> {{
                  notice.content }}
                </div>
                {% if session.get('is_admin') %}
                <a
                  href="{{ url_for('admin.delete_notice', notice_id=notice.id) }}"
                  class="text-secondary small"
                  onclick="return confirm('ì‚­ì œ?')"
                  ><i class="fas fa-times"></i
                ></a>
                {% endif %}
              </div>
              {% else %}
              <p class="text-muted small ms-2">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endfor %}
            </div>

            <h4 class="mb-3 fw-bold border-bottom pb-2">{{ gallery_name }}</h4>

            {% if request.args.get('q') and searched_galleries %}
            <div class="mb-4">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="fas fa-layer-group"></i> ê²€ìƒ‰ëœ ê°¤ëŸ¬ë¦¬
              </h6>
              <div class="d-flex flex-wrap gap-2">
                {% for sg in searched_galleries %}
                <a
                  href="{{ url_for('main.index', g_id=sg.id) }}"
                  class="btn btn-sm btn-outline-dark rounded-pill px-3"
                >
                  <i class="fas fa-hashtag"></i> {{ sg.name }}
                </a>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <div id="post-list" class="list-group shadow-sm">
              {% for post in posts %}
              <div class="list-group-item list-group-item-action p-3">
                <div class="d-flex flex-column">
                  <div
                    class="d-flex justify-content-between align-items-start mb-2"
                  >
                    <a
                      href="{{ url_for('main.post_detail', post_id=post.id) }}"
                      class="text-decoration-none w-100 me-3"
                    >
                      <div class="d-flex align-items-center mb-1">
                        {% if post.galleries %}
                        <span
                          class="badge bg-light text-dark border me-2 text-nowrap"
                          >{{ post.galleries.name }}</span
                        >
                        {% endif %}
                        <h5 class="mb-0 text-primary fw-bold text-truncate">
                          {{ post.title }}
                        </h5>
                      </div>
                      <p class="mb-1 text-secondary text-truncate">
                        {{ post.content }}
                      </p>
                    </a>

                    {% if session.get('user_id') and (session.get('user_id') ==
                    post.author_id or session.get('is_admin') or (post.galleries
                    and post.galleries.creator_id == session.get('user_id'))) %}
                    <div
                      class="d-flex gap-1"
                      style="position: absolute; top: 12px; right: 6px; z-index: 10;"
                    >
                      <a
                        href="{{ url_for('post.edit', post_id=post.id) }}"
                        class="btn btn-sm btn-outline-secondary shadow-sm"
                        style="background: white"
                        ><i class="fas fa-edit"></i
                      ></a>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger shadow-sm"
                        style="background: white"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{ post.id }}"
                      >
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                    {% endif %}
                  </div>

                  {% set ns = namespace(preview_url=none, found=false) %} {% if
                  post.file_urls and post.file_urls|length > 0 %} {% for url in
                  post.file_urls %} {% if not ns.found and not
                  (url.endswith('.mp3') or url.endswith('.wav') or
                  url.endswith('.ogg')) %} {% set ns.preview_url = url %} {% set
                  ns.found = true %} {% endif %} {% endfor %} {% elif
                  post.image_url %} {% set ns.preview_url = post.image_url %} {%
                  endif %} {% if ns.preview_url %}
                  <a
                    href="{{ url_for('main.post_detail', post_id=post.id) }}"
                    class="d-block mb-2"
                  >
                    {% if ns.preview_url.endswith('.mp4') or
                    ns.preview_url.endswith('.mov') or
                    ns.preview_url.endswith('.webm') %}
                    <video
                      src="{{ ns.preview_url }}"
                      class="post-img-preview"
                      preload="metadata"
                      playsinline
                      muted
                    ></video>
                    {% else %}
                    <img
                      src="{{ ns.preview_url }}"
                      class="post-img-preview"
                      alt="media"
                      loading="lazy"
                    />
                    {% endif %}
                  </a>
                  {% endif %}

                  <div class="small text-muted text-end">
                    <i class="fas fa-user-circle"></i> {{ post.users.username }}
                    {% if post.galleries and post.author_id ==
                    post.galleries.creator_id %}
                    <span
                      class="badge bg-dark text-warning ms-1"
                      style="font-size: 0.7rem; border: 1px solid #ffc107;"
                    >
                      <i class="fas fa-crown"></i> ê°¤ëŸ¬ë¦¬ ì¥
                    </span>
                    {% endif %}
                    <span
                      class="grade-badge"
                      data-grade="{{ post.users.grade or 'ì¼ë°˜' }}"
                      >{{ post.users.grade or 'ì¼ë°˜' }}</span
                    >
                    Â·
                    <span class="time-ago" data-date="{{ post.created_at }}"
                      >{{ post.created_at[:10] }}</span
                    >
                    Â· <i class="fas fa-eye ms-1"></i> {{ post.view_count }}
                  </div>
                </div>
              </div>
              {% else %}
              <div class="text-center p-5 text-muted bg-white border rounded">
                <p class="mb-0">ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              {% endfor %}
            </div>

            {% if posts|length >= 7 %}
            <div class="text-center mt-4 mb-5">
              <button
                id="loadMoreBtn"
                class="btn btn-outline-dark rounded-pill px-5 fw-bold shadow-sm"
                onclick="loadMore()"
              >
                ê²Œì‹œê¸€ ë”ë³´ê¸° <i class="fas fa-chevron-down ms-1"></i>
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="modal fade" id="noticeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">ê³µì§€ì‚¬í•­ ì‘ì„±</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <form
              action="/notice/write"
              method="POST"
              onsubmit="disableButton(this)"
            >
              <div class="modal-body">
                <input
                  type="text"
                  name="content"
                  class="form-control"
                  placeholder="ê³µì§€ ë‚´ìš©"
                  required
                />
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-danger">ë“±ë¡</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <footer class="text-center mt-5 mb-4 text-muted small">
        <div class="mb-3">
          <a
            href="/game"
            class="btn btn-outline-success rounded-pill px-4 fw-bold"
          >
            <i class="fas fa-gamepad"></i> ğŸ ì§€ë ì´ ê²Œì„í•˜ê¸°
          </a>
        </div>
        <button
          class="btn btn-link btn-sm text-decoration-none text-muted opacity-75"
          data-bs-toggle="modal"
          data-bs-target="#donationModal"
        >
          <i class="fas fa-ice-cream text-danger"></i> ê°œë°œìì—ê²Œ ë‹¬ì½¤í•œ
          ì•„ì´ìŠ¤í¬ë¦¼ ì‚¬ì£¼ê¸°
        </button>
        <br />
        <a href="/showcase">ğŸ¨ ì‡¼ì¼€ì´ìŠ¤ êµ¬ê²½í•˜ê¸°</a>
        <p>Secure Community Â© 2025</p>
      </footer>

      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
          <div
            class="modal-content border-0 shadow-lg"
            style="border-radius: 20px"
          >
            <div class="modal-header border-0 pb-0">
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body text-center pt-0 px-4 pb-4">
              <div class="donation-icon mb-3">ğŸ¦</div>

              <h5 class="fw-bold mb-2">ê°œë°œì ì‘ì›í•˜ê¸°</h5>
              <p class="text-muted small mb-4">
                ì•„ ì´ëŸ°ê±° ì•ˆì£¼ì…”ë„ ë˜ëŠ”ë°..<br />ì•„ ì§„ì§œ ê´œì°®ì€ë°.. ğŸ˜‹
              </p>

              <div class="mb-2 fw-bold small text-secondary">CREATOR: ATH</div>

              <div class="account-card mb-3 text-start">
                <div class="d-flex align-items-center mb-2">
                  <div class="bank-logo me-2">toss</div>
                  <span class="fw-bold">í† ìŠ¤ë±…í¬</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fs-5 fw-bold" style="letter-spacing: 0.5px"
                    >1908-8089-3265</span
                  >
                </div>
                <button
                  class="btn btn-dark btn-sm w-100 mt-2 rounded-pill fw-bold"
                  onclick="copyAccount()"
                >
                  <i class="far fa-copy"></i> ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬í•˜ê¸°
                </button>
              </div>

              <button
                class="btn btn-secondary w-100 fw-bold py-2 rounded-pill"
                data-bs-dismiss="modal"
              >
                ë‚˜ì¤‘ì— ì¤„ê²Œìš”
              </button>
            </div>
          </div>
        </div>
      </div>

      {% for post in posts %}
      <div class="modal fade" id="deleteModal{{ post.id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">ì‚­ì œ í™•ì¸</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <p>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            <div class="modal-footer justify-content-center">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                ì·¨ì†Œ
              </button>
              <a
                href="/delete/{{ post.id }}?g_id={{ request.args.get('g_id', '0') }}"
                class="btn btn-danger delete-link"
                onclick="disableDeleteLink(this)"
                >ì‚­ì œ</a
              >
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">ë¡œê·¸ì•„ì›ƒ í™•ì¸</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body text-center py-4">
              <p class="fs-5 mb-0">ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            <div class="modal-footer justify-content-center">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ì·¨ì†Œ
              </button>
              <a href="/logout" class="btn btn-danger fw-bold">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
          </div>
        </div>
      </div>
      {% if session.get('user_id') %} {% if request.args.get('g_id') and
      request.args.get('g_id') != '0' %}
      <button
        class="btn btn-primary write-btn"
        data-bs-toggle="modal"
        data-bs-target="#writeModal"
      >
        <i class="fas fa-pen"></i>
      </button>
      {% else %}
      <button
        class="btn btn-secondary write-btn"
        onclick="alert('ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ìƒë‹¨ì˜ ê°¤ëŸ¬ë¦¬(ê²Œì‹œíŒ)ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!')"
      >
        <i class="fas fa-pen"></i>
      </button>
      {% endif %} {% endif %}
      <div class="modal fade" id="writeModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">ìƒˆ ê¸€ ì‘ì„±</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form
              action="/write"
              method="POST"
              enctype="multipart/form-data"
              onsubmit="disableButton(this)"
            >
              <input
                type="hidden"
                name="gallery_id"
                value="{{ request.args.get('g_id', '0') }}"
              />

              <div class="modal-body">
                <input
                  type="text"
                  name="title"
                  class="form-control mb-2"
                  placeholder="ì œëª©"
                  required
                />

                <div class="input-group mb-2 shadow-sm">
                  <span class="input-group-text bg-white border-end-0 text-muted"
                    ><i class="fas fa-link"></i
                  ></span>
                  <input
                    type="url"
                    name="external_link"
                    class="form-control border-start-0 ps-0"
                    placeholder="https:// (ê´€ë ¨ ë§í¬ ì„ íƒ)"
                  />
                </div>

                <textarea
                  name="content"
                  class="form-control mb-3"
                  rows="5"
                  placeholder="ë‚´ìš©"
                  required
                ></textarea>

                <label class="small text-muted mb-1"
                  ><i class="fas fa-file-upload"></i> ì´ë¯¸ì§€, ìŒì•…, ì˜ìƒ (ì—¬ëŸ¬ ê°œ
                  ê°€ëŠ¥)</label
                >
                <input
                  type="file"
                  name="file"
                  class="form-control"
                  accept="image/*, video/*, audio/*"
                  multiple
                />
              </div>

              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">ë“±ë¡</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script>
                                            // 1. ê¸°ë³¸ ì„¤ì • (Supabase ë“±)
                                            const SUPABASE_URL = "https://porctgadcosjzgpkxiqw.supabase.co";
                                            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvcmN0Z2FkY29zanpncGt4aXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzc4MjYsImV4cCI6MjA4MTYxMzgyNn0.QmB0BnyLAYY0Rt3-fffExHQt4BGgWWr7USc5V9qbA2c";
                                            const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                                            // ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
                                            function copyAccount() {
                                              const account = "1908-8089-3265";
                                              navigator.clipboard.writeText(account).then(() => { alert("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¦\ní† ìŠ¤ë±…í¬ " + account); }).catch((err) => { alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ã… ã… "); });
                                            }

                                            // ì‹œê°„ ì—…ë°ì´íŠ¸
                                            function updateTimeAgo() {
                                              const els = document.querySelectorAll(".time-ago");
                                              const now = new Date();
                                              els.forEach((el) => {
                                                const dateStr = el.getAttribute("data-date");
                                                if (!dateStr) return;
                                                const diffMs = now - new Date(dateStr);
                                                const diffMin = Math.floor(diffMs / 60000);
                                                if (diffMin < 1) el.innerText = "ë°©ê¸ˆ ì „";
                                                else if (diffMin < 60) el.innerText = diffMin + "ë¶„ ì „";
                                                else el.innerText = Math.floor(diffMs / 86400000) > 0 ? Math.floor(diffMs / 86400000) + "ì¼ ì „" : Math.floor(diffMs / 3600000) + "ì‹œê°„ ì „";
                                              });
                                            }
                                            updateTimeAgo();

                                            // ì‹¤ì‹œê°„ êµ¬ë…
                                            const channel = _supabase.channel("index-updates")
                                              .on("postgres_changes", { event: "*", schema: "public", table: "posts" }, () => refreshPage())
                                              .on("postgres_changes", { event: "*", schema: "public", table: "notices" }, () => refreshPage())
                                              .on("postgres_changes", { event: "*", schema: "public", table: "users" }, () => refreshPage())
                                              .subscribe();

                                          async function refreshPage() {
            console.log("ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì‹œì‘...");
            try {
                // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¶™ì—¬ í˜„ì¬ í˜ì´ì§€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜´
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('t', Date.now());

                const response = await fetch(currentUrl.toString());
                const text = await response.text();
                const newDoc = new DOMParser().parseFromString(text, "text/html");

                // ë©”ì¸ ì½˜í…ì¸  ì˜ì—­(#main-content)ë§Œ ì¶”ì¶œí•´ì„œ êµì²´
                const newContent = newDoc.getElementById("main-content");
                const targetContainer = document.getElementById("main-content");

                if (newContent && targetContainer) {
                    targetContainer.innerHTML = newContent.innerHTML;
                    console.log("âœ… í™”ë©´ ê°±ì‹  ì™„ë£Œ!");
                    // ì‹œê°„ í‘œì‹œ(ë°©ê¸ˆ ì „ ë“±) ì¬ê³„ì‚°
                    if (typeof updateTimeAgo === 'function') updateTimeAgo();
                }
            } catch (err) {
                console.error("âŒ í™”ë©´ ê°±ì‹  ì‹¤íŒ¨:", err);
            }
        }

                                            function disableButton(form) {
                                              const btn = form.querySelector('button[type="submit"]');
                                              btn.disabled = true;
                                              btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë“±ë¡ ì¤‘...';
                                            }

                                            function disableDeleteLink(linkEl) {
                                              if (linkEl.classList.contains("disabled")) return false;
                                              linkEl.classList.add("disabled");
                                              linkEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ì‚­ì œ ì¤‘...';
                                              return true;
                                            }

                                            const navbarToggle = document.getElementById("navbarNav");
                                            const joinGuide = document.getElementById("join-guide");
                                            if (navbarToggle && joinGuide) {
                                              navbarToggle.addEventListener("show.bs.collapse", function () { joinGuide.classList.add("guide-hidden"); });
                                              navbarToggle.addEventListener("hidden.bs.collapse", function () { joinGuide.classList.remove("guide-hidden"); });
                                            }

                                            // 2. ğŸ”¥ [ê¸°ì¡´ ê¸°ëŠ¥] ê²Œì‹œê¸€ ë”ë³´ê¸° ë¡œì§ (ì ˆëŒ€ ì•ˆ ëºŒ)
                                            let currentOffset = 7;
                                            const currentGid = "{{ request.args.get('g_id', '0') }}";

                                            async function loadMore() {
                                              const btn = document.getElementById("loadMoreBtn");
                                              btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë¡œë”© ì¤‘...';
                                              btn.disabled = true;

                                              try {
                                                const res = await fetch(`/api/load_more?offset=${currentOffset}&g_id=${currentGid}`);
                                                const posts = await res.json();

                                                if (posts.length === 0) { btn.innerText = "ë” ì´ìƒ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤"; btn.disabled = true; return; }

                                                const listContainer = document.getElementById("post-list");
                                                const currentUserId = "{{ session.get('user_id') or '' }}";
                                                const isAdmin = "{{ session.get('is_admin') or '' }}" === "True";

                                                posts.forEach((post) => {
                                                  const createdDate = post.created_at.substring(0, 10);
                                                  const galleryBadge = post.galleries ? `<span class="badge bg-light text-dark border me-2 text-nowrap">${post.galleries.name}</span>` : "";
                                                  const galleryMasterBadge = (post.galleries && post.author_id == post.galleries.creator_id)
                                                    ? `<span class="badge bg-dark text-warning ms-1" style="font-size: 0.7rem; border: 1px solid #ffc107;"><i class="fas fa-crown"></i> ê°¤ëŸ¬ë¦¬ ì¥</span>`
                                                    : "";

                                                  let mediaHtml = "";
                                                  let targetUrl = null;
                                                  if (post.file_urls && Array.isArray(post.file_urls) && post.file_urls.length > 0) {
                                                      for (let u of post.file_urls) {
                                                          const lowerU = u.toLowerCase();
                                                          if (!lowerU.includes(".mp3") && !lowerU.includes(".wav") && !lowerU.includes(".ogg")) { targetUrl = u; break; }
                                                      }
                                                  } else if (post.image_url) { targetUrl = post.image_url; }

                                                  if (targetUrl) {
                                                      if (targetUrl.match(/\.(mp4|mov|webm)(\?|$)/i)) {
                                                          mediaHtml = `<a href="/post/${post.id}" class="d-block mb-2"><video src="${targetUrl}" class="post-img-preview" muted preload="metadata"></video></a>`;
                                                      } else {
                                                          mediaHtml = `<a href="/post/${post.id}" class="d-block mb-2"><img src="${targetUrl}" class="post-img-preview" loading="lazy"></a>`;
                                                      }
                                                  }

                                                  let actionButtons = "";
                                                  if (currentUserId == post.author_id || isAdmin || (post.galleries && post.galleries.creator_id == currentUserId)) {
                                                    actionButtons = `<div class="d-flex gap-1" style="position: absolute; top: 12px; right: 6px; z-index: 10;"><a href="/edit/${post.id}" class="btn btn-sm btn-outline-secondary shadow-sm" style="background: white"><i class="fas fa-edit"></i></a><button type="button" class="btn btn-sm btn-outline-danger shadow-sm" style="background: white" data-bs-toggle="modal" data-bs-target="#deleteModal${post.id}"><i class="fas fa-trash-alt"></i></button></div>`;
                                                  }

                                                  const html = `<div class="list-group-item list-group-item-action p-3 fade-in" style="position: relative;"><div class="d-flex flex-column"><div class="d-flex justify-content-between align-items-start mb-2"><a href="/post/${post.id}" class="text-decoration-none w-100 me-3"><div class="d-flex align-items-center mb-1">${galleryBadge}<h5 class="mb-0 text-primary fw-bold text-truncate">${post.title}</h5></div><p class="mb-1 text-secondary text-truncate">${post.content}</p></a>${actionButtons}</div>${mediaHtml}<div class="small text-muted text-end"><i class="fas fa-user-circle"></i> ${post.users.username} ${galleryMasterBadge} <span class="grade-badge" data-grade="${post.users.grade || "ì¼ë°˜"}">${post.users.grade || "ì¼ë°˜"}</span> Â· <span class="time-ago" data-date="${post.created_at}">${createdDate}</span> Â· <i class="fas fa-eye ms-1"></i> ${post.view_count}</div></div></div>`;
                                                  listContainer.insertAdjacentHTML("beforeend", html);
                                                });

                                                currentOffset += posts.length;
                                                btn.innerHTML = 'ê²Œì‹œê¸€ ë”ë³´ê¸° <i class="fas fa-chevron-down ms-1"></i>';
                                                btn.disabled = false;
                                                if (posts.length < 7) { btn.innerText = "ë§ˆì§€ë§‰ ê¸€ì…ë‹ˆë‹¤"; btn.disabled = true; }
                                                if (typeof updateTimeAgo === 'function') updateTimeAgo();
                                              } catch (e) { console.error(e); btn.innerText = "ì˜¤ë¥˜ ë°œìƒ"; btn.disabled = false; }
                                            }

                                            // 3. ğŸ”¥ [ìˆ˜ì •ëœ ê¸°ëŠ¥] ì‚¬ìš©ì ê°¤ëŸ¬ë¦¬ ë¡œì§ (ì¤‘ë³µ ì œê±° & ê²€ìƒ‰ í¬í•¨)
                                            let userGalleryOffset = 0;
                                            let modalSearchQuery = "";
                                            const userGalleryModal = document.getElementById('userGalleryModal');

                                            if (userGalleryModal) {
                                                userGalleryModal.addEventListener('show.bs.modal', function () {
                                                    userGalleryOffset = 0;
                                                    modalSearchQuery = "";

                                                    const searchInput = document.getElementById('modalSearchInput');
                                                    if (searchInput) searchInput.value = "";

                                                    document.getElementById('modal-gallery-list').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
                                                    const moreBtn = document.getElementById('modalLoadMoreBtn');
                                                    if(moreBtn) moreBtn.style.display = 'none';

                                                    fetchUserGalleries();
                                                });
                                            }

                                            function searchModalGalleries() {
                                                const inputEl = document.getElementById('modalSearchInput');
                                                if (!inputEl) return;

                                                modalSearchQuery = inputEl.value.trim();
                                                userGalleryOffset = 0;

                                                document.getElementById('modal-gallery-list').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
                                                const moreBtn = document.getElementById('modalLoadMoreBtn');
                                                if(moreBtn) moreBtn.style.display = 'none';

                                                fetchUserGalleries();
                                            }

                                            async function fetchUserGalleries(isMore = false) {
                                              const listContainer = document.getElementById("modal-gallery-list");
                                              const btn = document.getElementById("modalLoadMoreBtn");

                                              try {
                                                  const res = await fetch(`/api/load_more_galleries?offset=${userGalleryOffset}&q=${encodeURIComponent(modalSearchQuery)}`);
                                                  if(!res.ok) throw new Error("API Error");

                                                  const galleries = await res.json();

                                                  if (!isMore) listContainer.innerHTML = "";

                                                  if (galleries.length === 0) {
                                                      if (!isMore) {
                                                          const emptyMsg = modalSearchQuery
                                                              ? '<div class="col-12 text-center text-muted py-4"><i class="fas fa-search mb-2 fs-2 opacity-25"></i><br>ê²€ìƒ‰ëœ ê°¤ëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
                                                              : '<div class="col-12 text-center text-muted py-4">ìƒì„±ëœ ì‚¬ìš©ì ê°¤ëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                                                          listContainer.innerHTML = emptyMsg;
                                                      }
                                                      if(btn) btn.style.display = 'none';
                                                      return;
                                                  }

                                                  galleries.forEach(g => {
                                                      const lockIcon = g.is_secure ? '<span class="badge bg-warning text-dark ms-1" style="font-size:0.6rem"><i class="fas fa-lock"></i></span>' : '';
                                                      const html = `
                                                      <div class="col-md-6 col-lg-4">
                                                          <a href="/?g_id=${g.id}" class="text-decoration-none">
                                                              <div class="card h-100 border-0 shadow-sm hover-effect" style="transition: 0.2s;">
                                                                  <div class="card-body p-3">
                                                                      <h6 class="fw-bold text-dark mb-1 text-truncate">
                                                                          <i class="fas fa-hashtag text-primary small"></i> ${g.name} ${lockIcon}
                                                                      </h6>
                                                                      <p class="text-muted small mb-0 text-truncate">${g.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                                                                  </div>
                                                              </div>
                                                          </a>
                                                      </div>`;
                                                      listContainer.insertAdjacentHTML("beforeend", html);
                                                  });

                                                  userGalleryOffset += galleries.length;

                                                  if(btn) {
                                                      if (galleries.length < 6) btn.style.display = 'none';
                                                      else btn.style.display = 'inline-block';
                                                  }

                                              } catch (e) {
                                                  console.error(e);
                                                  if(listContainer) listContainer.innerHTML = '<div class="col-12 text-center text-danger py-4">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨<br><small class="text-muted">ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</small></div>';
                                                  if(btn) btn.style.display = 'none';
                                              }
                                            }
                                            // 1. ì•Œë¦¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

                                // 1. ì•Œë¦¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (í˜•ì‹: ì´ë¦„ë‹˜ì˜ ë‹µê¸€: "ë‚´ìš©")
                    

                    // 2. ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ë° ë°°ì§€ ìˆ¨ê¸°ê¸° (ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ í†µí•©)
                    async function markAsRead() {
                        await fetch('/api/notifications/read', { method: 'POST' });
                    }

                    document.addEventListener('DOMContentLoaded', function() {
                        const notiDropdown = document.querySelector('.dropdown');
                        if (notiDropdown) {
                            notiDropdown.addEventListener('hidden.bs.dropdown', function () {
                                const badge = document.getElementById('noti-badge');
                                if (badge) badge.style.display = 'none'; // ë‹«ìœ¼ë©´ ë°°ì§€ ì¦‰ì‹œ ìˆ¨ê¹€
                                markAsRead(); // ì„œë²„ì— ì½ìŒ ì²˜ë¦¬ ìš”ì²­
                            });
                        }
                    });

                    // 3. ğŸ”¥ ì‹¤ì‹œê°„ ê°ì§€ ë° ìë™ ê°±ì‹  (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
                    const currentUserId = "{{ session.get('user_id') or '' }}";
                    async function refreshPage() {
            console.log("ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì‹œì‘...");
            try {
                // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¶™ì—¬ í˜„ì¬ í˜ì´ì§€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜´
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('t', Date.now());

                const response = await fetch(currentUrl.toString());
                const text = await response.text();
                const newDoc = new DOMParser().parseFromString(text, "text/html");

                // ë©”ì¸ ì½˜í…ì¸  ì˜ì—­(#main-content)ë§Œ ì¶”ì¶œí•´ì„œ êµì²´
                const newContent = newDoc.getElementById("main-content");
                const targetContainer = document.getElementById("main-content");

                if (newContent && targetContainer) {
                    targetContainer.innerHTML = newContent.innerHTML;
                    console.log("âœ… í™”ë©´ ê°±ì‹  ì™„ë£Œ!");
                    // ì‹œê°„ í‘œì‹œ(ë°©ê¸ˆ ì „ ë“±) ì¬ê³„ì‚°
                    if (typeof updateTimeAgo === 'function') updateTimeAgo();
                }
            } catch (err) {
                console.error("âŒ í™”ë©´ ê°±ì‹  ì‹¤íŒ¨:", err);
            }
        }
                    // (1) ê²Œì‹œê¸€/ê³µì§€ì‚¬í•­/ìœ ì € ë³€ê²½ ì‹œ ìƒˆë¡œê³ ì¹¨ ì—†ì´ í™”ë©´ ìë™ ê°±ì‹ 
                    _supabase.channel("index-updates")
                        .on("postgres_changes", { event: "*", schema: "public", table: "posts" }, () => {
                            console.log("ìƒˆ ê¸€/ìˆ˜ì • ê°ì§€! í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.");
                            refreshPage(); // ğŸ‘ˆ ì—¬ê¸°ì„œ ì‚¬ìš©ìë‹˜ì´ ë§Œë“  í•¨ìˆ˜ê°€ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.
                        })
                        .on("postgres_changes", { event: "*", schema: "public", table: "notices" }, () => refreshPage())
                        .on("postgres_changes", { event: "*", schema: "public", table: "users" }, () => refreshPage())
                        .subscribe();

                    // (2) ë‚´ê²Œ ì˜¨ ì•Œë¦¼ ì‹¤ì‹œê°„ ê°ì§€
                    if (currentUserId) {
                        _supabase.channel('noti-check')
                            .on('postgres_changes', {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'notifications',
                                filter: `user_id=eq.${currentUserId}`
                            }, payload => {
                                console.log("ìƒˆ ì•Œë¦¼ ë„ì°©!");
                                updateNotifications();
                            })
                            .subscribe();
                    }

                    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹¤í–‰
                    updateNotifications();
      </script>
    </body>
  </html>
