<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ post.title }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .detail-img {
        max-width: 100%;
        height: auto;
        max-height: 500px;
        object-fit: contain;
        border-radius: 10px;
      }
      .post-content {
        font-size: 1.1rem;
        line-height: 1.7;
        word-break: break-all;
        white-space: pre-wrap;
      }
      .grade-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 3px;
        vertical-align: middle;
        color: white;
        font-weight: bold;
        background-color: #0d6efd;
      }
      .grade-badge[data-grade="ê³¨ë“œ"] {
        background-color: #ffd700;
        color: #000;
        border: 1px solid #e0c200;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
      }
      .grade-badge[data-grade="ë‹¤ì´ì•„ëª¬ë“œ"] {
        background-color: #00e1ff;
        color: #fff;
        box-shadow: 0 0 5px #00e1ff;
      }
      .grade-badge[data-grade="ë„ˆ ì§± ìµœê³ "] {
        background: linear-gradient(
          45deg,
          #ff0000,
          #ff7300,
          #fffb00,
          #48ff00,
          #00ffd5,
          #002bff,
          #7a00ff,
          #ff00c8,
          #ff0000
        );
        background-size: 400%;
        animation: rainbow 3s linear infinite;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      .grade-badge[data-grade="ê´€ë¦¬ì"] {
        background-color: #dc3545;
        box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
        border: 1px solid #a71d2a;
        padding-left: 8px;
        padding-right: 8px;
      }
      .grade-badge[data-grade="ê´€ë¦¬ì"]::before {
        content: "ğŸ‘‘ ";
      }
      @keyframes rainbow {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }
      .cmt-vote-btn {
        border: none;
        background: none;
        padding: 0;
        font-size: 0.85rem;
        color: #6c757d;
        margin-right: 12px;
        cursor: pointer;
        transition: 0.2s;
      }
      .cmt-vote-btn:hover {
        color: #0d6efd;
      }
      .cmt-vote-btn i {
        margin-right: 4px;
      }
    </style>
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4 px-3">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/"
          ><i class="fas fa-shield-alt"></i> Secure Community</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse justify-content-end"
          id="navbarNav"
        >
          <div class="navbar-nav align-items-center mt-3 mt-lg-0 gap-2">
            {% if session.get('is_admin') %}<a
              href="/admin"
              class="btn btn-warning btn-sm fw-bold w-100 w-lg-auto text-nowrap"
              ><i class="fas fa-cogs"></i> ê´€ë¦¬ì í˜ì´ì§€</a
            >{% endif %} {% if session.get('username') %}
            <span class="text-white fw-bold me-2 mb-2 mb-lg-0 text-nowrap"
              ><i class="fas fa-user"></i> {{ session.get('username') }} {% if
              session.get('is_admin') %}<span
                class="grade-badge"
                data-grade="ê´€ë¦¬ì"
                >ê´€ë¦¬ì</span
              >{% endif %}</span
            >
            <a
              href="/settings"
              class="btn btn-outline-light btn-sm w-100 w-lg-auto text-nowrap"
              ><i class="fas fa-cog"></i> ì„¤ì •</a
            >
            <a
              href="/logout"
              class="btn btn-outline-danger btn-sm w-100 w-lg-auto text-nowrap"
              onclick="return confirm('ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
              >ë¡œê·¸ì•„ì›ƒ</a
            >
            {% else %}
            <a
              href="/login"
              class="btn btn-light btn-sm fw-bold w-100 w-lg-auto text-nowrap"
              >ë¡œê·¸ì¸</a
            >
            <a
              href="/register"
              class="btn btn-outline-light btn-sm w-100 w-lg-auto text-nowrap"
              >íšŒì›ê°€ì…</a
            >
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8" id="main-content">
          <a
            href="/"
            class="text-decoration-none text-muted mb-3 d-inline-block fw-bold"
            >&larr; ëª©ë¡ìœ¼ë¡œ</a
          >

          <div class="card shadow-sm mb-4 border-0">
            <div class="card-body p-3 p-md-4">
              <h3 class="fw-bold mb-3">{{ post.title }}</h3>

              <div
                class="d-flex justify-content-between text-muted border-bottom pb-3 mb-4 small"
              >
                <span>
                  <i class="fas fa-user"></i> {{ post.users.username }}
                  <span
                    class="grade-badge"
                    data-grade="{{ post.users.grade or 'ì¼ë°˜' }}"
                    >{{ post.users.grade or 'ì¼ë°˜' }}</span
                  >
                </span>
                <span>
                  <i class="fas fa-eye"></i> {{ post.view_count }} Â·
                  <span class="time-ago" data-date="{{ post.created_at }}"
                    >{{ post.created_at[:16] }}</span
                  >
                </span>
              </div>

              {% if post.external_link %}
              <div class="mb-4">
                <div
                  class="alert alert-info d-flex align-items-center shadow-sm border-0 py-2"
                >
                  <i class="fas fa-link me-2 text-primary"></i>
                  <div class="text-truncate">
                    <a
                      href="{{ post.external_link }}"
                      target="_blank"
                      class="fw-bold text-decoration-none small"
                    >
                      {{ post.external_link }}
                      <i
                        class="fas fa-external-link-alt ms-1"
                        style="font-size: 0.7rem"
                      ></i>
                    </a>
                  </div>
                </div>
              </div>
              {% endif %} {% set file_list = post.file_urls if post.file_urls
              else ([post.image_url] if post.image_url else []) %} {% if
              file_list %}
              <div class="post-media-gallery mb-4 text-center">
                {% for url in file_list %} {% set lower_url = url|lower %}

                <div class="mb-3">
                  {% if '.mp3' in lower_url or '.wav' in lower_url or '.ogg' in
                  lower_url %}
                  <div
                    class="bg-dark p-2 rounded-pill d-flex align-items-center px-3 shadow-sm mx-auto"
                    style="max-width: 500px"
                  >
                    <i class="fas fa-music text-warning me-2"></i>
                    <audio
                      src="{{ url }}"
                      controls
                      class="w-100"
                      style="height: 30px"
                    ></audio>
                  </div>

                  {% elif '.mp4' in lower_url or '.mov' in lower_url or '.webm'
                  in lower_url or '.avi' in lower_url %}
                  <video
                    src="{{ url }}"
                    class="detail-img shadow-sm border"
                    controls
                    playsinline
                  ></video>

                  {% elif '.jpg' in lower_url or '.jpeg' in lower_url or '.png'
                  in lower_url or '.gif' in lower_url or '.webp' in lower_url %}
                  <img
                    src="{{ url }}"
                    class="detail-img shadow-sm border"
                    alt="ì´ë¯¸ì§€"
                    loading="lazy"
                  />

                  {% else %}
                  <div
                    class="card shadow-sm mx-auto text-start"
                    style="max-width: 600px;"
                  >
                    <div
                      class="card-body d-flex align-items-center justify-content-between p-3"
                    >
                      <div class="d-flex align-items-center overflow-hidden">
                        <div
                          class="rounded-circle bg-light p-3 me-3 text-primary"
                        >
                          <i class="fas fa-file-download fa-lg"></i>
                        </div>
                        <div class="text-truncate">
                          <h6 class="mb-0 text-dark text-truncate fw-bold">
                            ì²¨ë¶€íŒŒì¼ {{ loop.index }}
                          </h6>
                          <small class="text-muted text-truncate d-block"
                            >{{ url.split('/')[-1] }}</small
                          >
                        </div>
                      </div>
                      <a
                        href="{{ url }}"
                        class="btn btn-outline-primary btn-sm fw-bold ms-3 text-nowrap"
                        download
                        target="_blank"
                      >
                        <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
                      </a>
                    </div>
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% endif %}

              <div class="post-content mt-3">{{ post.content }}</div>

              <div
                id="vote-area"
                class="d-flex justify-content-center gap-2 mt-5"
              >
                <button
                  onclick="sendVote('like')"
                  id="btn-like"
                  class="btn rounded-pill {% if my_vote == 'like' %}btn-primary{% else %}btn-outline-primary{% endif %}"
                >
                  <i class="fas fa-thumbs-up"></i> ì¢‹ì•„ìš”
                  <span id="count-like">{{ like_count }}</span>
                </button>
                <button
                  onclick="sendVote('dislike')"
                  id="btn-dislike"
                  class="btn rounded-pill {% if my_vote == 'dislike' %}btn-danger{% else %}btn-outline-danger{% endif %}"
                >
                  <i class="fas fa-thumbs-down"></i> ì‹«ì–´ìš”
                  <span id="count-dislike">{{ dislike_count }}</span>
                </button>
              </div>

              {% if session.get('user_id') == post.author_id or
              session.get('is_admin') %}
              <div class="text-end mt-4">
                <a
                  href="/delete/{{ post.id }}"
                  class="btn btn-outline-danger btn-sm"
                  onclick="return confirm('ì‚­ì œ?')"
                  >ì‚­ì œ</a
                >
              </div>
              {% endif %}
            </div>
          </div>

          <div class="card shadow-sm border-0">
            <div class="card-header bg-white fw-bold py-3">
              <i class="far fa-comment-dots"></i> ëŒ“ê¸€
            </div>
            <div id="comment-list" class="list-group list-group-flush">
              {% for parent in parents %}
              <div class="list-group-item bg-white p-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong
                      >{{ parent.users.username }}
                      <span
                        class="grade-badge"
                        data-grade="{{ parent.users.grade or 'ì¼ë°˜' }}"
                        >{{ parent.users.grade or 'ì¼ë°˜' }}</span
                      ></strong
                    >
                    <small
                      class="text-muted time-ago ms-1"
                      data-date="{{ parent.created_at }}"
                      >{{ parent.created_at[:10] }}</small
                    >
                  </div>
                  {% if session.get('user_id') == parent.user_id or
                  session.get('is_admin') %}
                  <button
                    class="btn btn-sm text-danger p-0 border-0"
                    onclick="deleteComment({{ parent.id }})"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                  {% endif %}
                </div>
                <p class="mb-2 mt-1">{{ parent.content }}</p>
                <div class="d-flex align-items-center mb-2">
                  <button
                    class="cmt-vote-btn"
                    onclick="voteComment({{ parent.id }}, 'like')"
                  >
                    <i class="far fa-thumbs-up"></i>
                    <span id="cl-{{ parent.id }}"
                      >{{ parent.like_count or 0 }}</span
                    >
                  </button>
                  <button
                    class="cmt-vote-btn"
                    onclick="voteComment({{ parent.id }}, 'dislike')"
                  >
                    <i class="far fa-thumbs-down"></i>
                    <span id="cd-{{ parent.id }}"
                      >{{ parent.dislike_count or 0 }}</span
                    >
                  </button>
                  {% if session.get('user_id') %}
                  <button
                    class="btn btn-sm btn-link text-decoration-none p-0 text-muted"
                    style="font-size: 0.85rem"
                    data-bs-toggle="collapse"
                    data-bs-target="#replyForm{{ parent.id }}"
                  >
                    â†ª ë‹µê¸€ë‹¬ê¸°
                  </button>
                  {% endif %}
                </div>

                {% for reply in replies %} {% if reply.parent_id == parent.id %}
                <div
                  class="d-flex mt-2 ms-3 ms-md-4 p-2 bg-light rounded border-start border-3 border-primary"
                >
                  <div class="w-100">
                    <div
                      class="d-flex justify-content-between align-items-start"
                    >
                      <small class="fw-bold text-primary"
                        >{{ reply.users.username }}
                        <span
                          class="grade-badge"
                          data-grade="{{ reply.users.grade or 'ì¼ë°˜' }}"
                          >{{ reply.users.grade or 'ì¼ë°˜' }}</span
                        ></small
                      >
                      <div class="d-flex gap-2">
                        <small
                          class="text-muted time-ago"
                          data-date="{{ reply.created_at }}"
                          >{{ reply.created_at[:10] }}</small
                        >
                        {% if session.get('user_id') == reply.user_id or
                        session.get('is_admin') %}
                        <button
                          class="text-danger p-0 border-0 bg-transparent"
                          onclick="deleteComment({{ reply.id }})"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                        {% endif %}
                      </div>
                    </div>
                    <p class="mb-1 small">{{ reply.content }}</p>
                    <div class="d-flex align-items-center">
                      <button
                        class="cmt-vote-btn small"
                        onclick="voteComment({{ reply.id }}, 'like')"
                      >
                        <i class="far fa-thumbs-up"></i>
                        <span>{{ reply.like_count or 0 }}</span>
                      </button>
                      <button
                        class="cmt-vote-btn small"
                        onclick="voteComment({{ reply.id }}, 'dislike')"
                      >
                        <i class="far fa-thumbs-down"></i>
                        <span>{{ reply.dislike_count or 0 }}</span>
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %} {% endfor %}

                <div class="collapse mt-2" id="replyForm{{ parent.id }}">
                  <form
                    action="/comment/{{ post.id }}"
                    method="POST"
                    class="d-flex gap-2"
                  >
                    <input
                      type="hidden"
                      name="parent_id"
                      value="{{ parent.id }}"
                    />
                    <input
                      type="text"
                      name="content"
                      class="form-control form-control-sm"
                      placeholder="ë‹µê¸€ ì…ë ¥"
                      required
                    />
                    <button class="btn btn-sm btn-secondary text-nowrap">
                      ë“±ë¡
                    </button>
                  </form>
                </div>
              </div>
              {% else %}
              <div class="p-4 text-center text-muted">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
              {% endfor %}
            </div>
            {% if session.get('user_id') %}
            <div class="card-body border-top bg-light p-3">
              <form
                action="/comment/{{ post.id }}"
                method="POST"
                class="d-flex gap-2"
              >
                <input
                  type="text"
                  name="content"
                  class="form-control"
                  placeholder="ëŒ“ê¸€ ì…ë ¥..."
                  required
                /><button class="btn btn-primary">ë“±ë¡</button>
              </form>
            </div>
            {% else %}
            <div class="card-body text-center py-4">
              <a href="/login" class="fw-bold">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="cmtDeleteModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-danger text-white border-0">
            <h6 class="modal-title fw-bold">ëŒ“ê¸€ ì‚­ì œ</h6>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center py-4">
            <p class="mb-0 fw-bold">ì •ë§ ì´ ëŒ“ê¸€ì„ ì§€ìš¸ê¹Œìš”?</p>
          </div>
          <div class="modal-footer border-0 pt-0 justify-content-center">
            <button
              type="button"
              class="btn btn-light btn-sm px-3"
              data-bs-dismiss="modal"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              class="btn btn-danger btn-sm px-3"
              id="confirmCmtDelBtn"
            >
              ì‚­ì œí•˜ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const SUPABASE_URL = "https://porctgadcosjzgpkxiqw.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvcmN0Z2FkY29zanpncGt4aXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzc4MjYsImV4cCI6MjA4MTYxMzgyNn0.QmB0BnyLAYY0Rt3-fffExHQt4BGgWWr7USc5V9qbA2c";
      const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      const postId = "{{ post.id }}";

      // 1. ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬ ì œì–´ìš© ë³€ìˆ˜
      let targetCmtId = null;
      const cmtDeleteModal = new bootstrap.Modal(
        document.getElementById("cmtDeleteModal")
      );

      // 1. ëŒ“ê¸€ ì‚­ì œ
      function deleteComment(cmtId) {
        targetCmtId = cmtId;
        cmtDeleteModal.show();
      }

      document.getElementById("confirmCmtDelBtn").onclick = function () {
        fetch(`/comment/delete/${targetCmtId}`).then((r) => {
          console.log("ì‚­ì œ ì‘ë‹µ ì½”ë“œ:", r.status); // ğŸ” í™•ì¸ìš©
          if (r.status === 200) {
            cmtDeleteModal.hide();
            refreshPage();
          } else {
            r.text().then((msg) => alert("ì‹¤íŒ¨: " + msg));
          }
        });
      };

      // 2. ëŒ“ê¸€ íˆ¬í‘œ
      function voteComment(cmtId, type) {
        fetch(`/comment/vote/${cmtId}/${type}`)
          .then((r) => {
            if (r.status === 401) {
              alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            } else if (r.status === 200) {
              // âœ… ì„±ê³µ ì‹œ í™”ë©´ì„ ì¦‰ì‹œ ê°±ì‹ í•´ì„œ ìˆ«ìë¥¼ ë°”ê¿”ì¤ë‹ˆë‹¤.
              refreshPage();
            } else {
              alert("íˆ¬í‘œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          })
          .catch((e) => console.error("íˆ¬í‘œ ì—ëŸ¬:", e));
      }

      // ê²Œì‹œë¬¼ íˆ¬í‘œ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ë³´ê°•)
      function sendVote(type) {
        fetch(`/vote/${postId}/${type}`)
          .then((r) => r.json())
          .then((d) => {
            if (d.error) {
              alert(d.error);
            } else {
              // ë²„íŠ¼ ë””ìì¸ê³¼ ìˆ«ì ì—…ë°ì´íŠ¸
              document.getElementById("count-like").innerText = d.like_count;
              document.getElementById("count-dislike").innerText =
                d.dislike_count;
              document.getElementById("btn-like").className =
                "btn rounded-pill " +
                (d.my_vote === "like" ? "btn-primary" : "btn-outline-primary");
              document.getElementById("btn-dislike").className =
                "btn rounded-pill " +
                (d.my_vote === "dislike" ? "btn-danger" : "btn-outline-danger");
            }
          });
      }

      function updateButtons(l, d, v) {
        document.getElementById("count-like").innerText = l;
        document.getElementById("count-dislike").innerText = d;
        const bl = document.getElementById("btn-like"),
          bd = document.getElementById("btn-dislike");
        const bc = "btn rounded-pill ";
        bl.className =
          bc + (v === "like" ? "btn-primary" : "btn-outline-primary");
        bd.className =
          bc + (v === "dislike" ? "btn-danger" : "btn-outline-danger");
      }

      function updateTimeAgo() {
        const els = document.querySelectorAll(".time-ago");
        const now = new Date();
        els.forEach((el) => {
          const dateStr = el.getAttribute("data-date");
          if (!dateStr) return;
          const diffMs = now - new Date(dateStr);
          const diffMin = Math.floor(diffMs / 60000);
          if (diffMin < 1) el.innerText = "ë°©ê¸ˆ ì „";
          else if (diffMin < 60) el.innerText = diffMin + "ë¶„ ì „";
          else
            el.innerText =
              Math.floor(diffMs / 86400000) > 0
                ? Math.floor(diffMs / 86400000) + "ì¼ ì „"
                : Math.floor(diffMs / 3600000) + "ì‹œê°„ ì „";
        });
      }
      updateTimeAgo();

      // ğŸ‘‡ ì´ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” (ë§¨ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ ë¶€ë¶„)
      const channel = _supabase
        .channel("detail-updates")
        // 1. ëŒ“ê¸€ ì¢‹ì•„ìš” í…Œì´ë¸” ê°ì§€ (ì¶”ê°€ë¨!)
        .on(
          "postgres_changes",
          { event: "*", schema: "public", table: "comment_likes" },
          () => refreshPage()
        )
        // 2. ëŒ“ê¸€ í…Œì´ë¸” ê°ì§€
        .on(
          "postgres_changes",
          {
            event: "*",
            schema: "public",
            table: "comments",
            filter: `post_id=eq.${postId}`,
          },
          () => refreshPage()
        )
        // 3. ê²Œì‹œê¸€ ì¢‹ì•„ìš” í…Œì´ë¸” ê°ì§€
        .on(
          "postgres_changes",
          {
            event: "*",
            schema: "public",
            table: "likes",
            filter: `post_id=eq.${postId}`,
          },
          () => refreshPage()
        )
        // 4. ê²Œì‹œê¸€ ìˆ˜ì • ê°ì§€
        .on(
          "postgres_changes",
          {
            event: "*",
            schema: "public",
            table: "posts",
            filter: `id=eq.${postId}`,
          },
          () => refreshPage()
        )
        // 5. ìœ ì € ì •ë³´ ë³€ê²½ ê°ì§€
        .on(
          "postgres_changes",
          { event: "*", schema: "public", table: "users" },
          () => refreshPage()
        )
        .subscribe();

      async function refreshPage() {
        try {
          const res = await fetch(window.location.href + "?t=" + Date.now());
          const text = await res.text();
          const newDoc = new DOMParser().parseFromString(text, "text/html");
          document.getElementById("main-content").innerHTML =
            newDoc.getElementById("main-content").innerHTML;
          updateTimeAgo();
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
