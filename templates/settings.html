<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€ - Secure Community</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        :root { --primary-color: #0d6efd; --bg-color: #f4f6f9; --card-radius: 16px; }
        body { background-color: var(--bg-color); font-family: 'Pretendard', sans-serif; color: #333; }
        .settings-header { margin-bottom: 2rem; }
        .settings-nav { background: white; border-radius: var(--card-radius); padding: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); height: 100%; }
        .nav-pills .nav-link { color: #555; font-weight: 600; padding: 12px 20px; border-radius: 12px; margin-bottom: 8px; transition: all 0.2s; display: flex; align-items: center; }
        .nav-pills .nav-link i { margin-right: 12px; font-size: 1.1rem; width: 24px; text-align: center; }
        .nav-pills .nav-link:hover { background-color: #f8f9fa; color: var(--primary-color); transform: translateX(3px); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }
        .content-card { background: white; border-radius: var(--card-radius); padding: 2.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: none; height: 100%; }
        .section-title { font-weight: 800; font-size: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50; }
        .section-desc { color: #6c757d; margin-bottom: 2rem; font-size: 0.95rem; }
        .form-control { padding: 12px 15px; border-radius: 10px; border: 1px solid #dee2e6; background-color: #fcfcfc; }
        .form-control:focus { background-color: #fff; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1); }
        .btn-save { padding: 12px 0; border-radius: 10px; font-weight: 700; margin-top: 1rem; transition: all 0.3s; }
        .alert-custom { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .gallery-item { border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 15px; transition: 0.2s; }
        .gallery-item:hover { background-color: #f9f9f9; border-color: #ddd; }

        /* ğŸ”¥ [ì¶”ê°€] í™”ë ¤í•œ ì²´í¬ ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.5s;
        }
        .success-overlay.active { opacity: 1; visibility: visible; }
        
        .checkmark-circle {
            width: 150px; height: 150px; position: relative;
            display: inline-block; vertical-align: top;
        }
        /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */

        .checkmark-circle .background {
            width: 150px; height: 150px;
            border-radius: 50%; background: #28a745;
            position: absolute; left: 0; top: 0;
            /* ğŸ”¥ [ìˆ˜ì •ë¨] ê¸°ì¡´ 0.4s/0.9s -> 0.2s/0.4së¡œ ë‹¨ì¶• */
            animation: scale .2s ease-in-out .4s both;
        }
        
        .checkmark-circle .checkmark {
            border-radius: 5px; position: absolute; z-index: 10;
            stroke-width: 5; stroke: #fff; fill: none;
            stroke-dasharray: 100; stroke-dashoffset: 100;
            stroke-linecap: round; transform-origin: 50% 50%;
        }
        
        .checkmark-circle .checkmark.draw { 
            /* ğŸ”¥ [ìˆ˜ì •ë¨] ê¸°ì¡´ 1s/0.2s -> 0.45s/0.1së¡œ ë‹¨ì¶• */
            animation: draw 0.45s cubic-bezier(0.65, 0, 0.45, 1) 0.1s forwards; 
        }
        
        /* ... ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ ... */
        
        @keyframes draw { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    </style>
</head>
<body>

<div id="successOverlay" class="success-overlay">
    <div class="checkmark-circle">
        <div class="background"></div>
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
    </div>
    <h2 class="mt-4 fw-bold text-success animate-bounce">ê°¤ëŸ¬ë¦¬ ìƒì„± ì™„ë£Œ!</h2>
    <p class="text-muted">ë©‹ì§„ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš” âœ¨</p>
</div>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center settings-header">
        <div>
            <h2 class="fw-bold mb-1"><i class="fas fa-cog text-secondary me-2"></i>ì„¤ì • ë° ê´€ë¦¬</h2>
            <p class="text-muted mb-0">ê³„ì • ì •ë³´ì™€ ì»¤ë®¤ë‹ˆí‹° í™œë™ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
        </div>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-dark rounded-pill px-4 fw-bold">
            <i class="fas fa-arrow-left me-2"></i>ë©”ì¸ìœ¼ë¡œ
        </a>
    </div>

    {% if msg %}
    <div id="alertBox" class="alert alert-info alert-dismissible fade show alert-custom mb-4" role="alert" style="display: none;">
        <i class="fas fa-info-circle me-2"></i> {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-lg-3">
            <div class="settings-nav">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                    <button class="nav-link active" id="v-pills-security-tab" data-bs-toggle="pill" data-bs-target="#v-pills-security" type="button" role="tab">
                        <i class="fas fa-shield-alt"></i> ë³´ì•ˆ ì„¤ì •
                    </button>
                    <button class="nav-link" id="v-pills-gallery-tab" data-bs-toggle="pill" data-bs-target="#v-pills-gallery" type="button" role="tab">
                        <i class="fas fa-plus-square"></i> ê°¤ëŸ¬ë¦¬ ìƒì„±
                    </button>
                    <button class="nav-link" id="v-pills-manage-tab" data-bs-toggle="pill" data-bs-target="#v-pills-manage" type="button" role="tab">
                        <i class="fas fa-tasks"></i> ê°¤ëŸ¬ë¦¬ ê´€ë¦¬
                    </button>
                </div>
                <hr class="my-4 text-muted">
                <div class="px-3 text-muted small">
                    ë¡œê·¸ì¸ ê³„ì •:<br>
                    <strong class="text-dark">{{ session.get('username') }}</strong>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="tab-content h-100" id="v-pills-tabContent">
                
                <div class="tab-pane fade show active h-100" id="v-pills-security" role="tabpanel">
                    <div class="content-card">
                        <div class="d-flex align-items-center mb-1">
                            <h3 class="section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                        </div>
                        <p class="section-desc">ê³„ì •ì„ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.</p>
                        <form action="{{ url_for('auth.settings') }}" method="POST">
                            <input type="hidden" name="action" value="change_pw">
                            <div class="mb-3">
                                <label class="form-label fw-bold small">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" name="current_password" class="form-control" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold small">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" name="new_password" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-dark btn-save w-100">
                                <i class="fas fa-check me-2"></i>ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
                            </button>
                        </form>
                    </div>
                </div>

                <div class="tab-pane fade h-100" id="v-pills-gallery" role="tabpanel">
                    <div class="content-card">
                        <div class="d-flex align-items-center mb-1">
                            <h3 class="section-title text-primary">ë‚˜ë§Œì˜ ê°¤ëŸ¬ë¦¬ ë§Œë“¤ê¸°</h3>
                        </div>
                        <p class="section-desc">ìƒˆë¡œìš´ ì£¼ì œì˜ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ ìš´ì˜í•´ë³´ì„¸ìš”.</p>

                        <form action="{{ url_for('main.create_gallery') }}" method="POST">
                            <div class="mb-3">
                                <label class="form-label fw-bold small">ê°¤ëŸ¬ë¦¬ ì´ë¦„ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-quote-left"></i></span>
                                    <input type="text" name="name" class="form-control border-start-0 ps-0" placeholder="ì˜ˆ: ìš”ë¦¬ ê°¤ëŸ¬ë¦¬, ì¶•êµ¬ íŒ¬í´ëŸ½" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold small">ê°¤ëŸ¬ë¦¬ ì„¤ëª…</label>
                                <textarea name="description" class="form-control" rows="2" placeholder="ê°¤ëŸ¬ë¦¬ ì†Œê°œê¸€"></textarea>
                            </div>

                            <div class="mb-4 p-3 bg-light rounded-3 border">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="secureSwitch" name="is_secure">
                                    <label class="form-check-label fw-bold" for="secureSwitch">ğŸ”’ ë³´ì•ˆ ê°¤ëŸ¬ë¦¬ ì„¤ì •</label>
                                </div>
                                <div id="passwordField" style="display: none;">
                                    <label class="small text-muted mb-1">ì…ì¥ ë¹„ë°€ë²ˆí˜¸</label>
                                    <input type="password" name="password" class="form-control form-control-sm" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-save w-100">
                                <i class="fas fa-plus-circle me-2"></i>ê°¤ëŸ¬ë¦¬ ìƒì„±í•˜ê¸°
                            </button>
                        </form>
                    </div>
                </div>

                <div class="tab-pane fade h-100" id="v-pills-manage" role="tabpanel">
                    <div class="content-card">
                        <div class="d-flex align-items-center mb-1">
                            <h3 class="section-title text-success">ë‚´ ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</h3>
                        </div>
                        <p class="section-desc">ë‚´ê°€ ë§Œë“  ê°¤ëŸ¬ë¦¬ë¥¼ ê´€ë¦¬í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                        {% if my_galleries %}
                            {% for g in my_galleries %}
                            <div class="gallery-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="d-flex align-items-center mb-1">
                                        <h5 class="fw-bold mb-0 me-2">{{ g.name }}</h5>
                                        {% if g.is_secure %}
                                        <span class="badge bg-warning text-dark"><i class="fas fa-lock"></i> ë³´ì•ˆ</span>
                                        {% else %}
                                        <span class="badge bg-secondary">ì¼ë°˜</span>
                                        {% endif %}
                                    </div>
                                    <p class="small text-muted mb-0">{{ g.description or 'ì„¤ëª… ì—†ìŒ' }}</p>
                                </div>
                                <div class="d-flex gap-2">
                                    {% if g.is_secure %}
                                    <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#pwModal{{ g.id }}">
                                        <i class="fas fa-key"></i> ë¹„ë²ˆë³€ê²½
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal('{{ url_for('main.delete_gallery', gallery_id=g.id) }}', '{{ g.name }}')">
                                        <i class="fas fa-trash"></i> ì‚­ì œ
                                    </button>
                                </div>
                            </div>

                            {% if g.is_secure %}
                            <div class="modal fade" id="pwModal{{ g.id }}" tabindex="-1">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form action="{{ url_for('main.update_gallery_pw') }}" method="POST">
                                            <div class="modal-body">
                                                <input type="hidden" name="gallery_id" value="{{ g.id }}">
                                                <input type="password" name="new_password" class="form-control" placeholder="ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸" required>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-warning w-100">ë³€ê²½í•˜ê¸°</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fs-1 mb-3 opacity-50"></i>
                                <p>ìƒì„±í•œ ê°¤ëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="prettyDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header border-0 bg-danger text-white justify-content-center py-3">
                <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle"></i> ì‚­ì œ í™•ì¸</h5>
            </div>
            <div class="modal-body text-center py-4 px-4">
                <p class="mb-2 fs-5 fw-bold text-dark" id="delGalleryName"></p>
                <p class="text-muted small mb-0">
                    ì •ë§ë¡œ ì´ ê°¤ëŸ¬ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
                    <span class="text-danger fw-bold">í¬í•¨ëœ ëª¨ë“  ê²Œì‹œê¸€ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</span>
                </p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger rounded-pill px-4 fw-bold shadow-sm">
                    <i class="fas fa-trash-alt me-1"></i> ë„¤, ì‚­ì œí•©ë‹ˆë‹¤
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. ë³´ì•ˆ ê°¤ëŸ¬ë¦¬ ì²´í¬ë°•ìŠ¤ ë¡œì§
    const secureSwitch = document.getElementById('secureSwitch');
    const passwordField = document.getElementById('passwordField');
    if(secureSwitch && passwordField){
        secureSwitch.addEventListener('change', function() {
            passwordField.style.display = this.checked ? 'block' : 'none';
            passwordField.querySelector('input').required = this.checked;
        });
    }

    // 2. ğŸ”¥ [í•µì‹¬] URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ë° ìë™ íƒ­ ì´ë™ ë¡œì§
    document.addEventListener("DOMContentLoaded", function() {
        // URLì—ì„œ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const targetTab = urlParams.get('tab');
        const msg = "{{ msg or '' }}";

        // (1) íŠ¹ì • íƒ­ìœ¼ë¡œ ì´ë™í•´ì•¼ í•œë‹¤ë©´ ì´ë™
        if (targetTab === 'manage') {
            const manageTabBtn = document.querySelector('#v-pills-manage-tab');
            const tabInstance = new bootstrap.Tab(manageTabBtn);
            tabInstance.show();
        } else if (targetTab === 'create') {
            const createTabBtn = document.querySelector('#v-pills-gallery-tab');
            const tabInstance = new bootstrap.Tab(createTabBtn);
            tabInstance.show();
        }

        // (2) ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ ë° ì•Œë¦¼ ì²˜ë¦¬
        if (msg) {
            if (msg.includes("ìƒì„±")) {
                // ê°¤ëŸ¬ë¦¬ ìƒì„± ì„±ê³µ ì‹œ í™”ë ¤í•œ ì• ë‹ˆë©”ì´ì…˜
                const overlay = document.getElementById('successOverlay');
                const checkmark = document.querySelector('.checkmark');
                
                overlay.classList.add('active');
                checkmark.classList.add('draw');
                
                // ì• ë‹ˆë©”ì´ì…˜ í›„ ë‹«ê¸°
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 1200); 
            } else {
                // ì‚­ì œ, ìˆ˜ì • ë“± ì¼ë°˜ ë©”ì‹œì§€
                const alertBox = document.getElementById('alertBox');
                if(alertBox) alertBox.style.display = 'block';
            }

            // (3) ğŸ”¥ [ì¤‘ìš”] URL ì²­ì†Œ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë©”ì‹œì§€ ì¬ë°œìƒ ë°©ì§€)
            // í˜„ì¬ ì£¼ì†Œì—ì„œ ?msg=...&tab=... ë¶€ë¶„ì„ ì œê±°í•¨
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({path: newUrl}, '', newUrl);
        }
    });

    // 3. ì‚­ì œ ëª¨ë‹¬ ë„ìš°ê¸° í•¨ìˆ˜
    const delModalEl = document.getElementById('prettyDeleteModal');
    const delModal = new bootstrap.Modal(delModalEl);
    
    function openDeleteModal(deleteUrl, galleryName) {
        document.getElementById('delGalleryName').innerText = galleryName;
        document.getElementById('confirmDeleteBtn').href = deleteUrl;
        delModal.show();
    }
</script>

</body>
</html>